{% extends 'base.html' %}

{% block script %}
<script>
    function content_changed() {
        console.log("Content changed! ")
        // gather all fields and send them to server
        const rows = Array.from(document.getElementsByClassName("quest_row"))
        console.log(rows)
        console.log(typeof rows)
        let data = {}
        rows.forEach(row => {
            const children = row.children
            data[row.id] = {
                "name": children[0].textContent,
                "type": children[1].textContent,
                "description": children[2].textContent ? JSON.parse(children[2].textContent) : null,
                "reward": JSON.parse(children[3].textContent),
            }
        })
        data = JSON.stringify(data)
        console.log(data, " | ", typeof data)
        try {
            fetch(location.href, {method: "POST", body: data, headers: {"content-type": "application/json"}})
                .then((data) => {
                    console.log(data);
                });
        } catch (error) {
            console.log("ERROR: ", error)
        }
    }
</script>
{% endblock %}

{% block content %}
<h1>Quests:</h1>

<table border="1" style="border-collapse: collapse">
    <tbody>
    <tr style="font-weight: bold">
        <td style="width: 200px">Name</td>
        <td style="width: 300px">Type</td>
        <td style="width: 400px">Description</td>
        <td style="width: 400px">Reward</td>
    </tr>
    {% for quest in quests %}
        <tr contenteditable class="quest_row" id="{{ quest["id"] }}">
            <td style="width: 200px">{{ quest["name"] }}</td>
            <td style="width: 300px">{{ quest["type"] }}</td>
            <td style="width: 400px">{{ quest["description"] | tojson }}</td>
            <td style="width: 400px">{{ quest["reward"] | tojson }}</td>
            <td contenteditable="false">
                <form method="get" style="margin: auto" action="/admin/remove_quest">
                    <input name="quest_id" type="hidden" value="{{ quest.id }}"/>
                    <input type="submit" value="Remove"/>
                </form>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<h2>Save changes:</h2>
<button onclick="content_changed()">Save changes</button>

<h2>Add Quest</h2>
<form action="/admin/add_quest">
    <input type="text" name="quest_name" required placeholder="Name [string]" style="width: 190px">
    <input type="text" name="quest_type" required placeholder="Type [string]" style="width: 290px">
    <input type="text" name="quest_description" placeholder="Description [JSON]" style="width: 390px">
    <input type="text" name="quest_reward" required placeholder="Reward [JSON]" style="width: 390px">
    <input type="submit">
</form>
<hr>
Possible rewards:<br>
<pre><code class="language-json">
{
    "glory": 1,
    "fortune": 1,
    "exp": 1,
    "item": {
        "name": "aura_4",
        "count": 2, [Optional]
        "gem": "unimagined_treasury" [Optional]
    }
}
</code></pre>
{% endblock %}